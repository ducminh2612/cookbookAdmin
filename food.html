<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <title>Quản lí món ăn</title>
    <style>
        a,
        li,
        ul {
            padding: 0;
            text-decoration: none;
        }
        #add-food-form,
        #edit-food-form {
            width: 40%;
        }

        @media (max-width: 768px) {
            #add-food-form,
            #edit-food-form {
                width: 90%;
            }
        }
    </style>
</head>

<body>
    <section id="sidebar">
		<a href="#" class="brand">
			<i class='bx bxs-smile'></i>
			<span class="text">Easy Food</span>
		</a>
		<ul class="side-menu top">
			<li >
				<a href="category.html">
					<i class='bx bx-category'></i>
					<span class="text">Danh mục món ăn</span>
				</a>
			</li>
			<li class="active">
				<a href="food.html">
					<i class='bx bx-cylinder' ></i>
					<span class="text">Món ăn</span>
				</a>
			</li>
			<li>
				<a href="feedback.html">
					<i class='bx bx-comment-dots' ></i>
					<span class="text">Đánh giá</span>
				</a>
			</li>
			<li>
				<a href="request.html">	
					<i class='bx bx-task-x'></i>
					<span class="text">Yêu cầu công thức</span>
				</a>
			</li>
            <li>
                <a href="recipes.html">  
                    <i class='bx bxl-discord-alt'></i>
                    <span class="text">Công thức cộng đồng</span>
                </a>
            </li>
			<li>
				<a href="#">
					<i class='bx bxs-group' ></i>
					<span class="text">Tài khoản</span>
				</a>
			</li>
		</ul>
		<ul class="side-menu">
			<li>
				<a href="#">
					<i class='bx bxs-cog' ></i>
					<span class="text">Cài đặt</span>
				</a>
			</li>
			<li>
				<a href="#" class="logout">
					<i class='bx bxs-log-out-circle' ></i>
					<span class="text">Đăng xuất</span>
				</a>
			</li>
		</ul>
	</section>
    <section id="content">
        <!-- NAVBAR -->
        <nav>
            <i class='bx bx-menu'></i>
            <a href="#" class="nav-link">Món ăn</a>
            <form action="#">
                <div class="form-input">
                    <input type="search" placeholder="Search...">
                    <button type="submit" class="search-btn"><i class='bx bx-search'></i></button>
                </div>
            </form>
            <input type="checkbox" id="switch-mode" hidden>
            <label for="switch-mode" class="switch-mode"></label>
            <a href="#" class="notification">
                <i class='bx bxs-bell'></i>
                <span class="num">1</span>
            </a>
            <a href="#" class="profile">
                <img src="img/people.png">
            </a>
        </nav>
        <main>
            <!-- Form thêm món ăn -->
            <form id="add-food-form" class="m-auto" style="border:1px solid #004972; padding: 12px; border-radius: 5px;">
                <h5 class="text-center text-success">Thêm món ăn</h5>
                <label for="name">Tên món ăn <span style="color: red;">*</span></label>
                <input type="text" id="name" placeholder="Tên món ăn" class="form-control mb-2" required>
                <label for="categoryId">ID danh mục <span style="color: red;">*</span></label>
                <input type="number" id="categoryId" placeholder="ID danh mục" class="form-control mb-2" required>
                <label for="categoryName">Tên danh mục <span style="color: red;">*</span></label>
                <input type="text" id="categoryName" placeholder="Tên danh mục" class="form-control mb-2" required>
                <label for="image">Hình ảnh <span style="color: red;">*</span></label>
                <input type="url" id="image" placeholder="URL hình ảnh" class="form-control mb-2" required>
                <label for="url">URL <span style="color: red;">*</span></label>
                <input type="url" id="url" placeholder="URL món ăn" class="form-control mb-2" required>
                <label for="featured">Nổi bật</label>
                <select id="featured" class="form-select mb-2">
                    <option value="true">True</option>
                    <option value="false">False</option>
                </select>
                <label for="count">Lượt xem</label>
                <input type="number" id="count" placeholder="Số lượng" class="form-control mb-2">
                <button type="submit" class="btn btn-success w-100">Thêm món ăn</button>
            </form>


            <!-- Form sửa món ăn -->
            <form id="edit-food-form" class="m-auto" style="border:1px solid #004972; padding: 12px; border-radius: 5px; display: none;">
                <h5 class="text-center text-warning">Sửa món ăn</h5>
                <label for="edit-name">Tên món ăn <span style="color: red;">*</span></label>
                <input type="text" id="edit-name" placeholder="Tên món ăn" class="form-control mb-2" required>
                <label for="edit-categoryId">ID danh mục <span style="color: red;">*</span></label>
                <input type="number" id="edit-categoryId" placeholder="ID danh mục" class="form-control mb-2" required>
                <label for="edit-categoryName">Tên danh mục <span style="color: red;">*</span></label>
                <input type="text" id="edit-categoryName" placeholder="Tên danh mục" class="form-control mb-2" required>
                <label for="edit-image">Hình ảnh <span style="color: red;">*</span></label>
                <input type="url" id="edit-image" placeholder="URL hình ảnh" class="form-control mb-2" required>
                <label for="edit-url">URL <span style="color: red;">*</span></label>
                <input type="url" id="edit-url" placeholder="URL món ăn" class="form-control mb-2" required>
                <label for="edit-featured">Nổi bật</label>
                <select id="edit-featured" class="form-select mb-2">
                    <option value="true">True</option>
                    <option value="false">False</option>
                </select>
                <label for="edit-count">Lượt xem</label>
                <input type="number" id="edit-count" placeholder="Số lượng" class="form-control mb-2">
                <button type="submit" class="btn btn-warning w-100">Cập nhật món ăn</button>
            </form>


            <h4 class="text-center mt-4">Danh sách món ăn</h4>
            <table id="food-list" class="table table-hover table-bordered text-center">
                <tr>
                    <td>Tên món ăn</td>
                    <td>Danh mục</td>
                    <td>Hình ảnh</td>
                    <td>URL</td>
                    <td>Nổi bật</td>
                    <td>Lượt xem</td>
                    <td>Yêu thích</td>
                    <td>Lịch sử</td>
                    <td>Đánh giá</td>
                    <td>Thao tác</td>
                </tr>
            </table>
            
        </main>
    </section>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

        const firebaseConfig = {
    apiKey: "AIzaSyDaskTUPCkY6qx46KH5zJ2gI7wDXfATEWs",
    authDomain: "cookbook-4178a.firebaseapp.com",
    databaseURL: "https://cookbook-4178a-default-rtdb.firebaseio.com",
    projectId: "cookbook-4178a",
    storageBucket: "cookbook-4178a.appspot.com",
    messagingSenderId: "277595686841",
    appId: "1:277595686841:web:01639c409215360e73d868"
  };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        document.addEventListener("DOMContentLoaded", function() {
        const addFoodForm = document.getElementById("add-food-form");
        const editFoodForm = document.getElementById("edit-food-form");
        const foodList = document.getElementById("food-list");

        function fetchFoods() {
            get(ref(db, 'food')).then((snapshot) => {
                if (snapshot.exists()) {
                    const foods = snapshot.val();
                    foodList.innerHTML = "";
                    foodList.innerHTML = `<tr>
                            <td>Tên món ăn</td>
                            <td>Danh mục</td>
                            <td>Hình ảnh</td>
                            <td>URL</td>
                            <td>Nổi bật</td>
                            <td>Số lượng</td>
                            <td>Yêu thích</td>
                            <td>Lịch sử</td>
                            <td>Đánh giá</td>
                            <td>Thao tác</td>
                        </tr>`;
                    for (const [id, food] of Object.entries(foods)) {
                        foodList.innerHTML += `
                            <tr>
                                <td>${food.name}</td>
                                <td>${food.categoryName}</td>
                                <td><img src="${food.image}" alt="Food Image" width="50"></td>
                                <td><a href="${food.url}" target="_blank">Xem</a></td>
                                <td>${food.featured ? 'Có' : 'Không'}</td>
                                <td>${food.count}</td>
                                <td>${food.favorite ? Object.keys(food.favorite).length : 0}</td>
                                <td>${food.history ? Object.keys(food.history).length : 0}</td>
                                <td>${food.rating ? Object.keys(food.rating).length : 0}</td>
                                <td>
                                    <button onclick="editFood('${id}', '${food.name}', '${food.categoryId}', '${food.categoryName}', '${food.image}', '${food.url}', ${food.featured ? 'true' : 'false'}, ${food.count})" class="btn btn-warning btn-sm">Sửa</button>
                                    <button onclick="deleteFood('${id}')" class="btn btn-danger btn-sm">Xóa</button>
                                </td>

                            </tr>`;
                    }
                } else {
                    foodList.innerHTML = "<tr><td colspan='10'>Chưa có món ăn nào.</td></tr>";
                }
            }).catch((error) => {
                console.error("Lỗi khi lấy dữ liệu món ăn: ", error);
            });
        }

        function addFood(name, categoryId, categoryName, image, url, featured, count) {
            const newFoodId = Date.now().toString(); 
            set(ref(db, `food/${newFoodId}`), {
                name: name,
                categoryId: Number(categoryId), 
                categoryName: categoryName,
                image: image,
                url: url,
                featured: Boolean(featured), 
                count: parseInt(count, 10),  
                favorite: {},
                history: {},
                rating: {}
            }).then(() => {
                Swal.fire('Thành công!', 'Món ăn đã được thêm.', 'success');
                addFoodForm.reset();
                fetchFoods();
            }).catch((error) => {
                console.error("Lỗi khi thêm món ăn: ", error);
                Swal.fire('Lỗi!', 'Có lỗi xảy ra khi thêm món ăn.', 'error');
            });
        }

        addFoodForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const name = addFoodForm.querySelector('[id="name"]').value;
            const categoryId = addFoodForm.querySelector('[id="categoryId"]').value;
            const categoryName = addFoodForm.querySelector('[id="categoryName"]').value;
            const image = addFoodForm.querySelector('[id="image"]').value;
            const url = addFoodForm.querySelector('[id="url"]').value;
            const featured = addFoodForm.querySelector('[id="featured"]').checked;
            const count = addFoodForm.querySelector('[id="count"]').value;
            addFood(name, categoryId, categoryName, image, url, featured, count);
        });

        window.editFood = function(id, name, categoryId, categoryName, image, url, featured, count) {
            document.getElementById("edit-food-form").style.display = "block";
            document.getElementById("edit-name").value = name;
            document.getElementById("edit-categoryId").value = categoryId;
            document.getElementById("edit-categoryName").value = categoryName;
            document.getElementById("edit-image").value = image;
            document.getElementById("edit-url").value = url;
            document.getElementById("edit-featured").value = featured ? "true" : "false";
            document.getElementById("edit-count").value = count;
            editFoodForm.dataset.foodId = id;
        };



        editFoodForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const id = editFoodForm.dataset.foodId; 
            const name = document.getElementById("edit-name").value;
            const categoryId = Number(document.getElementById("edit-categoryId").value); 
            const categoryName = document.getElementById("edit-categoryName").value;
            const image = document.getElementById("edit-image").value;
            const url = document.getElementById("edit-url").value;
            const featured = document.getElementById("edit-featured").value === "true";
            const count = parseInt(document.getElementById("edit-count").value, 10); 

            // Cập nhật dữ liệu vào Firebase
            const foodRef = ref(db, 'food/' + id);
            update(foodRef, {
                name: name,
                categoryId: categoryId,
                categoryName: categoryName,
                image: image,
                url: url,
                featured: featured,
                count: count
            }).then(() => {
                editFoodForm.reset();
                document.getElementById("edit-food-form").style.display = "none";
                fetchFoods(); // Cập nhật danh sách món ăn
                Swal.fire('Thành công!', 'Món ăn đã được cập nhật.', 'success');
            }).catch((error) => {
                console.error("Lỗi khi cập nhật dữ liệu: ", error);
            });
        });



        window.deleteFood = function(id) {
            Swal.fire({
                title: 'Bạn có chắc chắn muốn xóa món ăn này?',
                text: "Hành động này không thể hoàn tác!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    const foodRef = ref(db, 'food/' + id);
                    remove(foodRef).then(() => {
                        fetchFoods();
                        Swal.fire('Đã xóa!', 'Món ăn đã được xóa.', 'success');
                    }).catch((error) => {
                        console.error("Lỗi khi xóa món ăn: ", error);
                    });
                }
            });
        };



        fetchFoods();
    });
    </script>
</body>

</html>


<script src="/script.js"></script>
<script src="script.js"></script>